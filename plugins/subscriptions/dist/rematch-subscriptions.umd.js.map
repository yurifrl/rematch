{"version":3,"file":"rematch-subscriptions.umd.js","sources":["../lib/subscriptions.js","../lib/handlers.js","../lib/create.js","../lib/omit.js","../lib/unsubscribe.js","../lib/index.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.subscriptions = new Map();\nexports.patternSubscriptions = new Map();\n//# sourceMappingURL=subscriptions.js.map","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar subscriptions_1 = require(\"./subscriptions\");\n// matches actions with letter/number characters & -, _\nvar actionRegex = /^[A-Z0-9-_]+\\/[A-Z0-9-_]+$/i;\n// valid pattern match: letters/numbers &_-, *\n// match on 'a/*', '*/b', 'a-*/b', etc.\n// note: cannot match * or creates infinite loop`\nvar patternRegex = /^[A-Z0-9-_*]+\\/[A-Z0-9-_*]+$/i;\nvar escapeRegex = function (str) { return str.replace('*', '.*'); };\nvar isAction = function (matcher, regex) { return !!matcher.match(regex); };\nexports.onHandlers = function (call) { return function (matcher) {\n    if (isAction(matcher, actionRegex)) {\n        // exact match on create or unsubscribe\n        call(subscriptions_1.subscriptions, matcher);\n    }\n    else if (isAction(matcher, patternRegex)) {\n        // pattern match on create\n        var formattedMatcher = \"^\" + escapeRegex(matcher) + \"$\";\n        call(subscriptions_1.patternSubscriptions, formattedMatcher);\n    }\n    else if (matcher[0] === '^') {\n        // pattern match, already formatted. Called by unsubscribe\n        // NOTE: this should probably live elsewhere\n        call(subscriptions_1.patternSubscriptions, matcher);\n    }\n    else {\n        throw new Error(\"Invalid subscription matcher: \" + matcher);\n    }\n}; };\n//# sourceMappingURL=handlers.js.map","\"use strict\";\nvar __assign = (this && this.__assign) || Object.assign || function(t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n        s = arguments[i];\n        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n            t[p] = s[p];\n    }\n    return t;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar handlers_1 = require(\"./handlers\");\nexports.createSubscription = function (modelName, matcher, onAction, actionList) {\n    var createHandler = function (target, formattedMatcher) {\n        // prevent infinite loops within models by validating against\n        // subscription matchers in the action name\n        actionList.forEach(function (actionName) {\n            var regex = new RegExp(formattedMatcher);\n            if ((modelName + \"/\" + actionName).match(regex)) {\n                throw new Error(\"Subscription (\" + formattedMatcher + \") cannot match action name (\" + actionName + \") in its own model.\");\n            }\n        });\n        // handlers match on { modelName: onAction }\n        // to allow multiple subscriptions in different models\n        var handler = (_a = {}, _a[modelName] = onAction, _a);\n        if (target.has(formattedMatcher)) {\n            handler = __assign({}, target.get(formattedMatcher), handler);\n        }\n        target.set(formattedMatcher, handler);\n        var _a;\n    };\n    handlers_1.onHandlers(createHandler)(matcher);\n};\n//# sourceMappingURL=create.js.map","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\n// omit key from an object\nexports.default = (function (prop, obj) {\n    if (obj === void 0) { obj = {}; }\n    return Object.keys(obj).reduce(function (next, key) {\n        if (key !== prop) {\n            next[key] = obj[key];\n        }\n        return next;\n    }, {});\n});\n//# sourceMappingURL=omit.js.map","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar handlers_1 = require(\"./handlers\");\nvar omit_1 = require(\"./omit\");\nvar unsubscribeFrom = function (modelName) { return function (target, formattedMatcher) {\n    var handler = target.get(formattedMatcher);\n    var next = omit_1.default(modelName, handler);\n    if (Object.keys(next).length) {\n        // still other hooks under matcher\n        target.set(formattedMatcher, next);\n    }\n    else {\n        // no more hooks under matcher\n        target.delete(formattedMatcher);\n    }\n}; };\n// creates an unsubscribe function that can be called within a model\nexports.createUnsubscribe = function (modelName, matcher) { return function () {\n    handlers_1.onHandlers(unsubscribeFrom(modelName))(matcher);\n}; };\n//# sourceMappingURL=unsubscribe.js.map","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar create_1 = require(\"./create\");\nvar subscriptions_1 = require(\"./subscriptions\");\nvar unsubscribe_1 = require(\"./unsubscribe\");\nvar localGetState;\nexports.default = (function () { return ({\n    init: function (_a) {\n        var validate = _a.validate;\n        var triggerAllSubscriptions = function (matches) { return function (action, matcher) {\n            // call each subscription in each model\n            Object.keys(matches).forEach(function (modelName) {\n                // create subscription with (action, unsubscribe)\n                matches[modelName](action, localGetState(), function () { return unsubscribe_1.createUnsubscribe(modelName, matcher)(); });\n            });\n        }; };\n        return {\n            onStoreCreated: function (store) {\n                localGetState = store.getState;\n            },\n            onModel: function (model) {\n                // a list of actions is only necessary\n                // to create warnings for invalid subscription names\n                var actionList = Object.keys(model.reducers || {}).concat(Object.keys(model.effects || {}));\n                Object.keys(model.subscriptions || {}).forEach(function (matcher) {\n                    validate([\n                        [\n                            !!matcher.match(/\\/(.+)?\\//),\n                            \"Invalid subscription matcher (\" + matcher + \")\",\n                        ],\n                        [\n                            typeof model.subscriptions[matcher] !== 'function',\n                            \"Subscription matcher in \" + model.name + \" (\" + matcher + \") must be a function\",\n                        ],\n                    ]);\n                    var onAction = model.subscriptions[matcher];\n                    create_1.createSubscription(model.name, matcher, onAction, actionList);\n                });\n            },\n            middleware: function () { return function (next) { return function (action) {\n                var type = action.type;\n                // exact match\n                if (subscriptions_1.subscriptions.has(type)) {\n                    var allMatches = subscriptions_1.subscriptions.get(type);\n                    // call each hook[modelName] with action\n                    triggerAllSubscriptions(allMatches)(action, type);\n                }\n                else {\n                    subscriptions_1.patternSubscriptions.forEach(function (handler, matcher) {\n                        if (type.match(new RegExp(matcher))) {\n                            var patternMatches = subscriptions_1.patternSubscriptions.get(matcher);\n                            triggerAllSubscriptions(patternMatches)(action, matcher);\n                        }\n                    });\n                }\n                return next(action);\n            }; }; },\n        };\n    }\n}); });\n//# sourceMappingURL=index.js.map"],"names":["Object","defineProperty","exports","value","Map","actionRegex","patternRegex","isAction","matcher","regex","match","call","subscriptions_1","subscriptions","formattedMatcher","replace","patternSubscriptions","Error","__assign","this","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","modelName","onAction","actionList","handlers_1","onHandlers","target","forEach","actionName","RegExp","_a","handler","has","get","set","prop","obj","keys","reduce","next","key","omit_1","default","delete","unsubscribeFrom","localGetState","init","validate","triggerAllSubscriptions","matches","action","unsubscribe_1","createUnsubscribe","onStoreCreated","store","getState","onModel","model","reducers","concat","effects","name","create_1","createSubscription","middleware","type","allMatches","patternMatches"],"mappings":"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"}