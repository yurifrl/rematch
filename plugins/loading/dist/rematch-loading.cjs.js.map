{"version":3,"file":"rematch-loading.cjs.js","sources":["../lib/index.js"],"sourcesContent":["\"use strict\";\nvar __assign = (this && this.__assign) || Object.assign || function(t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n        s = arguments[i];\n        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n            t[p] = s[p];\n    }\n    return t;\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = y[op[0] & 2 ? \"return\" : op[0] ? \"throw\" : \"next\"]) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [0, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar cntState = {\n    global: 0,\n    models: {},\n    effects: {},\n};\nvar createLoadingAction = function (converter, i) { return function (state, _a) {\n    var name = _a.name, action = _a.action;\n    cntState.global += i;\n    cntState.models[name] += i;\n    cntState.effects[name][action] += i;\n    return __assign({}, state, { global: converter(cntState.global), models: __assign({}, state.models, (_b = {}, _b[name] = converter(cntState.models[name]), _b)), effects: __assign({}, state.effects, (_c = {}, _c[name] = __assign({}, state.effects[name], (_d = {}, _d[action] = converter(cntState.effects[name][action]), _d)), _c)) });\n    var _b, _c, _d;\n}; };\nvar validateConfig = function (config) {\n    if (config.name && typeof config.name !== 'string') {\n        throw new Error('loading plugin config name must be a string');\n    }\n    if (config.asNumber && typeof config.asNumber !== 'boolean') {\n        throw new Error('loading plugin config asNumber must be a boolean');\n    }\n    if (config.whitelist && !Array.isArray(config.whitelist)) {\n        throw new Error('loading plugin config whitelist must be an array of strings');\n    }\n    if (config.blacklist && !Array.isArray(config.blacklist)) {\n        throw new Error('loading plugin config blacklist must be an array of strings');\n    }\n    if (config.whitelist && config.blacklist) {\n        throw new Error('loading plugin config cannot have both a whitelist & a blacklist');\n    }\n};\nexports.default = (function (config) {\n    if (config === void 0) { config = {}; }\n    validateConfig(config);\n    var loadingModelName = config.name || 'loading';\n    var converter = config.asNumber === true\n        ? function (cnt) { return cnt; }\n        : function (cnt) { return cnt > 0; };\n    var loading = {\n        name: loadingModelName,\n        reducers: {\n            hide: createLoadingAction(converter, -1),\n            show: createLoadingAction(converter, 1),\n        },\n        state: __assign({}, cntState),\n    };\n    cntState.global = 0;\n    loading.state.global = converter(cntState.global);\n    return {\n        config: {\n            models: {\n                loading: loading,\n            },\n        },\n        init: function (_a) {\n            var dispatch = _a.dispatch;\n            return ({\n                onModel: function (_a) {\n                    var _this = this;\n                    var name = _a.name;\n                    // do not run dispatch on \"loading\" model\n                    if (name === loadingModelName) {\n                        return;\n                    }\n                    cntState.models[name] = 0;\n                    loading.state.models[name] = converter(cntState.models[name]);\n                    loading.state.effects[name] = {};\n                    var modelActions = dispatch[name];\n                    // map over effects within models\n                    Object.keys(modelActions).forEach(function (action) {\n                        if (dispatch[name][action].isEffect !== true) {\n                            return;\n                        }\n                        cntState.effects[name][action] = 0;\n                        loading.state.effects[name][action] = converter(cntState.effects[name][action]);\n                        var actionType = name + \"/\" + action;\n                        // ignore items not in whitelist\n                        if (config.whitelist && !config.whitelist.includes(actionType)) {\n                            return;\n                        }\n                        // ignore items in blacklist\n                        if (config.blacklist && config.blacklist.includes(actionType)) {\n                            return;\n                        }\n                        // copy orig effect pointer\n                        var origEffect = dispatch[name][action];\n                        // create function with pre & post loading calls\n                        var effectWrapper = function () {\n                            var props = [];\n                            for (var _i = 0; _i < arguments.length; _i++) {\n                                props[_i] = arguments[_i];\n                            }\n                            return __awaiter(_this, void 0, void 0, function () {\n                                return __generator(this, function (_a) {\n                                    switch (_a.label) {\n                                        case 0:\n                                            _a.trys.push([0, , 2, 3]);\n                                            dispatch.loading.show({ name: name, action: action });\n                                            return [4 /*yield*/, origEffect.apply(void 0, props)];\n                                        case 1:\n                                            _a.sent();\n                                            return [3 /*break*/, 3];\n                                        case 2:\n                                            dispatch.loading.hide({ name: name, action: action });\n                                            return [7 /*endfinally*/];\n                                        case 3: return [2 /*return*/];\n                                    }\n                                });\n                            });\n                        };\n                        // replace existing effect with new wrapper\n                        dispatch[name][action] = effectWrapper;\n                    });\n                },\n            });\n        },\n    };\n});\n//# sourceMappingURL=index.js.map"],"names":["__assign","this","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","__generator","body","f","y","g","_","label","sent","trys","ops","verb","throw","return","Symbol","iterator","v","op","TypeError","pop","push","defineProperty","exports","cntState","global","models","effects","createLoadingAction","converter","state","_a","_b","_c","_d","name","action","config","Error","asNumber","whitelist","Array","isArray","blacklist","validateConfig","loadingModelName","cnt","loading","reducers","hide","show","init","dispatch","onModel","_this","keys","forEach","isEffect","actionType","includes","origEffect","props","_i"],"mappings":"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"}